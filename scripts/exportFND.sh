#! /bin/sh

MYSQL_HOST="127.0.0.1";
DB="fnd";
TABLE="fndImport";
CVETYPE="";
DATE=$(date +%Y%m%d);

getType()
{
  SOURCE="/tmp/sourceType";

  mysql -h ${MYSQL_HOST} ${DB} -NB -e "SELECT DISTINCT source FROM ${TABLE};" > ${SOURCE};
  cat << EOF
[CVE Types]
-----------
EOF
  while read cve; do
    index=$(grep -n "^${cve}" ${SOURCE} | cut -d':' -f1);
    echo " - ${index}) ${cve}";
  done < ${SOURCE}
  while [[ -z ${CVETYPE} ]]; do
    echo "Choose your CVE type: \c";
    read input;
    val=$(sed "${input}q;d" ${SOURCE});
    if [[ ${input} =~ ^[0-9]+$ && ! (-z ${val}) ]]; then
      CVETYPE=${val};
      echo "You have chosen ${CVETYPE}";
    else
      echo "Not a valid selection!";
    fi
  done && rm -rf ${SOURCE};
  exportData;
}

exportData()
{
  SOURCE="/tmp/source_data";
  CVE=$(echo ${CVETYPE} | sed "s/ //g");
  FILE="/tmp/${DATE}_${CVE}.json";
  DESC="";
  FINDINGS="";
  REMEDIATION="";
  URL="";
  SYSID="";

  touch ${FILE};
  echo "[\n{\c" > ${FILE};

  mysql -h ${MYSQL_HOST} ${DB} -NB -e "SELECT DISTINCT finding_id,bapp_id,tracking_id,app_reference,finding,remediation_plan FROM ${TABLE} WHERE source LIKE '${CVETYPE}';" | tr -d '\' > ${SOURCE};
  sed -i '' -e "s/\"/'/g" ${SOURCE};
  awk '{print $2}' ${SOURCE} | sort -u | while read line; do
    FND=($(grep "\t${line}\t" ${SOURCE} | awk '{print $1}'));
    APP=$(grep "\t${line}\t" ${SOURCE} | sed "s/\t/|/g" | cut -d'|' -f4 | uniq);
    REMEDIATION=$(grep "\t${line}\t" ${SOURCE} | sed "s/\t/|/g" | cut -d'|' -f6);
    FINDINGS=$(grep "\t${line}\t" ${SOURCE} | sed "s/\t/|/g" | cut -d'|' -f5);
    [[ ${#FND[@]} -gt 1 ]] && HANDLER="SR - ${APP} | ${line} | Multiple FNDs" || HANDLER="SR - ${APP} | ${line} | ${FND}";
    echo "\n  \"ShortDesc\": \"${HANDLER}\"," >> ${FILE};
    if [[ ${#FND[@]} -gt 1 ]]; then
      for fnd in "${!FND[@]}"; do
        SYSID=$(grep ${FND[$fnd]} ${SOURCE} | sed "s/\t/|/g" | cut -d'|' -f3);
        FINDINGS=$(grep ${FND[$fnd]} ${SOURCE} | sed "s/\t/|/g" | cut -d'|' -f5);
        REMEDIATION=$(grep ${FND[$fnd]} ${SOURCE} | sed "s/\t/|/g" | cut -d'|' -f6);
        [[ -z ${REMEDIATION} ]] && REMEDIATION=" ";
        URL="[REMOVED]";
        DESC="  \"Description${fnd}\": \"[${FND[$fnd]}][${URL}]\",\n  \"Findings${fnd}\": \"${FINDINGS}\",\n  \"Remediation${fnd}\": \"${REMEDIATION}\",";
        echo "${DESC}" >> ${FILE};
      done;
    else
      SYSID=$(grep ${line} ${SOURCE} | sed "s/\t/|/g" | cut -d'|' -f3 | uniq);
      URL="[REMOVED]";
      DESC="  \"Description\": \"[${FND}][${URL}]\",\n  \"Findings\": \"${FINDINGS}\",\n  \"Remediation\": \"${REMEDIATION}\",";
      echo "${DESC}" >> ${FILE};
    fi
    truncate -s -2 ${FILE}
    echo "\n},\n{\c" >> ${FILE};
  done && rm -rf ${SOURCE};
  truncate -s -3 ${FILE}
  echo "\n]" >> ${FILE};
  sed -i '' -e "s/\t/ /g" ${FILE} && sed -i '' -e "s/\r/ /g" ${FILE} && sed -i '' -e "s/\"\"/\"/g" ${FILE} && sed -i '' -e "s/\"Remediation\": \"$/\"Remediation\": \" \"\n/g" ${FILE};
  echo "Successfully create file: [ ${FILE} ]";
  echo "Would you like to automatically create RITMs for this file? [Y/N]: \c";
  read input;
  if [[ $(echo ${input} | grep -Ei "^Y$") ]]; then
    echo "Creating RITMs...";
    cd ../snowcat;
    ./createFND ${FILE};
  else
    echo "Exiting...";
  fi
}


if [[ -z ${CVETYPE} ]]; then
  getType;
else
  exportData;
fi
